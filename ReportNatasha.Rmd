---
title: "Title"
author: "R.H; S.Y"
date: "Tuesday, Feb 03, 2015"
output:
  pdf_document:
    number_sections: yes
---

```{r knitr_options, include=FALSE}
library(knitr)
opts_chunk$set(include = FALSE,echo = FALSE, eval = FALSE)
```

```{r read_data}
rm(list = ls())
## read 0\1 data:
ZO_data <- read.csv(file = "Oct29_2014_Xray_B6N_MGPSelect_Oor1_cleanV2.csv") # 8176 rows ,79 columns 

## 46 variables of interest:
XrayVariableList <- c("Number.Of.Thoracic.Vertebrae","Number.Of.Lumbar.Vertebrae","Number.Of.Pelvic.Vertebrae","Number.Of.Caudal.Vertebrae", "Transitional.Vertebrae" , "Shape.Of.Vertebrae","Fusion.Of.Vertebrae", "Processes.On.Vertebrae","Maxilla","Zygomatic.Bone","Number.Of.Cervical.Vertebrae","Skull.Shape","Number.Of.Ribs.Right","Number.Of.Ribs.Left","Shape.Of.Ribcage","Shape.Of.Ribs","Rib.Fusions","Clavicle","Scapula"  ,"Humerus","Radius","Ulna","Pelvis","Femur","Tibia","Fibula","Joints","Shape.Of.Spine","Teeth","Mandible","Number.Of.Digits","Digit.Integrity","Syndactylism","Polysyndactylism","Brachydactylism","Kyphosis","Lordosis","Scoliosis","Spinous.Processes","Transverse.Processes","Fusion.Processes","Caudal.Processes","Cervical.Processes","Lumbar.Processes","Sacral.Processes","Thoracic.Processes")    

## remove 3 variables with no values:
XrayVariableList_c <- XrayVariableList[!(XrayVariableList %in% c("Spinous.Processes","Transverse.Processes","Processes.On.Vertebrae"))]

## remove 3 cases with all NA's; keep variables of interest only:
ZO_data1 <- ZO_data[-which(apply(ZO_data[XrayVariableList_c],1,function(x) all(is.na(x))))
,c("Colony.Prefix","Genotype2","Genotype",XrayVariableList_c)]

## number of mices in each KO group (except WT group)
n_t     <- aggregate(. ~ Genotype2 + Colony.Prefix, data = ZO_data1, subset = Genotype2 !="WT",function(x) sum(!is.na(x)),na.action=NULL)

## number of NAs in each KO group (except WT group)
na_KO <- aggregate(. ~ Genotype2 + Colony.Prefix, data = ZO_data1, subset = Genotype2 !="WT", function(x) sum(is.na(x)),na.action=NULL)

## number of mices-marked-with-one in each KO group (except WT group)
n <- aggregate(. ~ Genotype2 + Colony.Prefix,data = ZO_data1,subset = Genotype2 !="WT",
               sum, na.action=NULL, na.rm=T)

## the number of mices in the WT group
N_minus_n_t <- aggregate(. ~ Genotype2 ,data = ZO_data1,subset = Genotype2 =="WT",
                         function(x) sum(!is.na(x)),na.action=NULL)

## number NAs in the WT group
na_WT <- aggregate(. ~ Genotype2 ,data = ZO_data1,subset = Genotype2 =="WT",
                         function(x) sum(is.na(x)),na.action=NULL)

## number of mices-marked-with-one in the WT
n_u_minus_n <- aggregate(. ~ Genotype2 ,data = ZO_data1,subset = Genotype2 =="WT",
                         sum, na.action=NULL, na.rm=T)

### Objects dimensions and descriptions:
## n           : 473 X 43 - number of faulted mice in each of the 473 KO (rows) in each outcome (columns)
## n_t         : 473 X 43 - number of tested  mice in each of the 473 KO (rows) in each outcome (columns)
## n_u_minus_n : 1 X 43   - number of faulted WT in each outcome (columns)
## N_minus_n_t : 1 X 43   - number of tested  WT in each outcome (columns)
## na_KO       : 473 X 43 - number of NAs in each KO and outcome
## na_WT       : 1 X 43   - number of NAs in WT for each outcome

### more notations:
## n_u - faulted mice in total
## B   - last value in the support of HG distribution, is min{n_t,n_u} - the minimum between total faults in both groups and tested mice in KO group

## 2X2 contingency for given Outcome and KO: (EDIT) 
# |||||
# |--|:--:|--|:--:|
# ||$n$|$n_t-n$|$n_t$|
# ||$n_u-n$|$N-n_t-n_u+n$|$N-n_t$|
# ||$n_u$|$N-n_u$|$N$


```

```{r functions_definitions}
# ---------------- functions definitions: -----------------------------------------

## get size of the Tarone family, given alpha_stars: 
# finds K(alpha)=inf{1:j|m(alpha,j)<=j} where m(alpha,j)=#{i|alpha_star[i]<=alpha/j}
findK <- function(alpha_star,alpha,verbose=T)
{
  la    <- length(alpha_star) 
  m     <- vector(length=la)
  for (j in 1:la)    m[j] <- sum(alpha_star<=(alpha/j))
  if (m[1]==0) K <- 0 else
    K <- (1:la)[which(m<=(1:la))[1]]
  if (is.na(K)) stop("something is wrong, check alpha_star for NAs and findK() definition")
  if (verbose) cat("K = ",K,"\n")
  return (K)
}

# estimate pi0 conditional expectation over U[0,1] (Dickhaus 2012):
Pi_0_est_EU <- function(p,f_n,kappa,in_fam,lambda)
{
  ## size of the sub-family:
  m_tag <- sum(in_fam)
  ## logical vector of size of in_fam that indicates where p-value is between lambda and lambda + next step in pdf:
  lpl <- (lambda < p[in_fam]) & (p[in_fam] <= lambda + kappa[in_fam]*f_n[in_fam])
  ## formula for the conditional expectation over uniform (0,1):
  ecdf_lambda_EU <- (sum(p[in_fam]<=lambda))/m_tag + (sum(1 - (p[in_fam][lpl]-lambda) / (kappa[in_fam][lpl]*f_n[in_fam][lpl]) ))/m_tag
  ## and the expectation of the pi_0 estimate
  Pi_0_hat_EU <- (1-ecdf_lambda_EU)/(1-lambda)
  return(Pi_0_hat_EU)
}

# adaptive BH given pi0 estimate: 
p_adjust_adaptive <- function(p,pi_0_hat)
{
  lp <- length(p)
  i <- lp:1L
  o <- order(p, decreasing = TRUE)
  ro <- order(o)
  pmin(1, cummin(lp*pi_0_hat/i * p[o]))[ro]
}

## print 2X2 table for OUTCOME j and KO i:
ptable <- function(i,j)
{
  n_u1 <- n_u_minus_n[1,3+j]+n[i,3+j]
  N1 <- N_minus_n_t[1,3+j] + n_t[i,3+j]
  n_t1 <- n_t[i,3+j]
  n1  <- n[i,3+j]
  tb <- matrix(c(n1     ,n_u1-n1       ,  n_u1,
               n_t1-n1,N1-n_t1-n_u1+n1,N1-n_u1,
               n_t1   ,N1-n_t1        ,N1),
               nrow=3,ncol=3,byrow=T)
  dimnames(tb) <- list("Defected"=c("Y","N","TOTAL"),
                       "Group"=c("KO","WT","TOTAL"))
  tbna <- matrix(c(na_KO[i,3+j],na_WT[1,3+j],na_KO[i,3+j]+na_WT[i,3+j]),nrow=1,ncol=3,byrow=T)
  dimnames(tbna) <- list("#NAs","Group"=c("KO","WT","TOTAL"))
  return(tb)
}

```

```{r all_outcomes_together_analysis}
lambda <- 0.05
alpha  <- 0.05
# ---------------- reshape data for analysis of all KO together: ---------

vec_n_t         <- as.vector(as.matrix(n_t[-(1:3)]))
vec_na_KO       <- as.vector(as.matrix(na_KO[-(1:3)]))
vec_n           <- as.vector(as.matrix(n[-(1:3)]))
vec_N_minus_n_t <- rep(as.vector(as.matrix(N_minus_n_t[-(1:3)])),each=nrow(n))
vec_na_WT       <- rep(as.vector(as.matrix(na_WT[-(1:3)])),each=nrow(n))
vec_n_u_minus_n <- rep(as.vector(as.matrix(n_u_minus_n[-(1:3)])),each=nrow(n))

# ---------------- get statistics: ---------------------------------------

## work with phyper() notation:
mm <- vec_n_u_minus_n + vec_n
nn <- vec_N_minus_n_t + vec_n_t - mm
kk  <- vec_n_t
BB  <- pmin(mm,kk)
xx  <- pmin(vec_n,BB)

## get pv (right tail)
p  <- dhyper(x = xx, m = mm, n = nn, k = kk) + phyper(q = xx, m = mm, n = nn, k = kk, lower.tail = FALSE)

## get "alpha star" (the minimum attainable p-value due to discreteness):
alpha_star <- dhyper(x=BB, m = mm, n = nn, k = kk)

## get the highest pdf value within the observed significance:
f_n <- dhyper(x = xx, m = mm, n = nn, k = kk)

## get the number of occurences of this value (usually one):
kappa <- apply(cbind(BB,mm,nn,kk,f_n),1,
             function(x) sum(dhyper(x = 0:x[1], m = x[2], n = x[3], k = x[4])==x[5]))

# ---------- sub families sizes and indices: --------------------------- 

F_alpha       <- alpha_star <= alpha
size_F_alpha  <- sum(F_alpha)
K             <- 12125 # findK(alpha_star)
F_Gilb        <- alpha_star <= alpha/K

fam_size             <- c(length(p),size_F_alpha,K)

# ---------- Adjustment 1 original pv -------------------

## BH adjustment:
pa_BH <- p.adjust(p,"BH")

## BH on alpha_star-smaller-than-alpha:
pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p.adjust(p[F_alpha],"BH")

## BH on Tarone family:
pa_Gilb <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p.adjust(p[F_Gilb],"BH")

pa_1 <- cbind(pa_BH,pa_BH_alpha,pa_Gilb)

# ---------- Adjustment 2 : adaptive pv -------------------
# get pi_0 estimates for each sub family:
pi_0_all   <- Pi_0_est_EU(p,f_n,kappa,in_fam = rep(T,length(p)),lambda = lambda)
pi_0_alpha <- Pi_0_est_EU(p,f_n,kappa,in_fam = F_alpha,lambda = lambda)
pi_0_Tar   <- Pi_0_est_EU(p,f_n,kappa,in_fam = F_Gilb ,lambda = lambda)

pi0 <- c(pi_0_all,pi_0_alpha,pi_0_Tar)


# adjustment:
pa_BH      <- p_adjust_adaptive(p = p, pi_0_hat = pi_0_all)

pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p_adjust_adaptive(p = p[F_alpha], pi_0_hat = pi_0_alpha)

pa_Gilb    <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb]      <- p_adjust_adaptive(p = p[F_Gilb] , pi_0_hat = pi_0_Tar)

pa_2  <- cbind(pa_BH,pa_BH_alpha,pa_Gilb)

# ---------- Adjustment 3 : mid pv --------------------------------
p_mid <- p - f_n*0.5

pa_BH <- p.adjust(p_mid,"BH")

pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p.adjust(p_mid[F_alpha],"BH")

pa_Gilb <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p.adjust(p_mid[F_Gilb],"BH")

pa_3  <- cbind(pa_BH,pa_BH_alpha,pa_Gilb)

# ---------- Adjustment 2 : adaptive pv -------------------
pa_BH       <- p_adjust_adaptive(p = p_mid, pi_0_hat = pi_0_all)

pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p_adjust_adaptive(p = p_mid[F_alpha], pi_0_hat = pi_0_alpha)

pa_Gilb     <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p_adjust_adaptive(p = p_mid[F_Gilb] , pi_0_hat = pi_0_Tar)

pa_4 <- cbind(pa_BH,pa_BH_alpha,pa_Gilb)

#-------------------- summarize results: ---------------------------

tb_all <- cbind(fam_size,pi0,
      apply(pa_1,2,function(x) sum(x<=alpha)),
      apply(pa_2,2,function(x) sum(x<=alpha)),
      apply(pa_3,2,function(x) sum(x<=alpha)),
      apply(pa_4,2,function(x) sum(x<=alpha)))

oc_ind <- rep(1:43,each=473)

tb_rej_in_each_oc_0_05 <- cbind(tapply(pa_1[,2],oc_ind,function(x) sum(x<=alpha)),
                         tapply(pa_2[,2],oc_ind,function(x) sum(x<=alpha)),
                         tapply(pa_3[,2],oc_ind,function(x) sum(x<=alpha)),
                         tapply(pa_4[,2],oc_ind,function(x) sum(x<=alpha)))
tb_rej_in_each_oc_Gilb <- cbind(tapply(pa_1[,3],oc_ind,function(x) sum(x<=alpha)),
                         tapply(pa_2[,3],oc_ind,function(x) sum(x<=alpha)),
                         tapply(pa_3[,3],oc_ind,function(x) sum(x<=alpha)),
                         tapply(pa_4[,3],oc_ind,function(x) sum(x<=alpha)))

save(tb_all,tb_rej_in_each_oc_0_05,tb_rej_in_each_oc_Gilb,file="tables_all.RData")

```

```{r each_OC_separately_function}
main_proc <- function(p,alpha_star,f_n,kappa,alpha,lambda)
{
# ---------- sub families sizes and indices: --------------------------- 
#browser()
F_alpha       <- alpha_star <= alpha
size_F_alpha  <- sum(F_alpha)
K             <- findK(alpha_star,alpha)
if (K==0) F_Gilb <- rep(F,length(alpha_star)) else
  F_Gilb <- alpha_star <= alpha/K
fam_size      <- c(size_F_alpha,K)

# ---------- Adjustment 1 original pv -------------------
## BH on alpha_star-smaller-than-alpha:
pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p.adjust(p[F_alpha],"BH")

## BH on Tarone family:
pa_Gilb <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p.adjust(p[F_Gilb],"BH")

pa_1 <- cbind(pa_BH_alpha,pa_Gilb)

# ---------- Adjustment 2 : adaptive pv -------------------
# get pi_0 estimates for each sub family:
if (size_F_alpha<50) pi_0_alpha <- NA else
  pi_0_alpha <- Pi_0_est_EU(p,f_n,kappa,in_fam = F_alpha,lambda = lambda)
if (K<50) pi_0_Tar <- NA else
  pi_0_Tar   <- Pi_0_est_EU(p,f_n,kappa,in_fam = F_Gilb ,lambda = lambda)

pi0 <- c(pi_0_alpha,pi_0_Tar)

# adjustment:
pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p_adjust_adaptive(p = p[F_alpha], pi_0_hat = pi_0_alpha)

pa_Gilb    <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p_adjust_adaptive(p = p[F_Gilb] , pi_0_hat = pi_0_Tar)

pa_2 <- cbind(pa_BH_alpha,pa_Gilb)

# ---------- Adjustment 3 : mid pv --------------------------------
p_mid <- p - f_n*0.5

pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p.adjust(p_mid[F_alpha],"BH")

pa_Gilb <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p.adjust(p_mid[F_Gilb],"BH")

pa_3  <- cbind(pa_BH_alpha,pa_Gilb)

# ---------- Adjustment 2 : adaptive pv -------------------
pa_BH_alpha <- rep(1,length(F_alpha))
pa_BH_alpha[F_alpha] <- p_adjust_adaptive(p = p_mid[F_alpha], pi_0_hat = pi_0_alpha)

pa_Gilb     <- rep(1,length(F_Gilb))
pa_Gilb[F_Gilb] <- p_adjust_adaptive(p = p_mid[F_Gilb] , pi_0_hat = pi_0_Tar)

pa_4 <- cbind(pa_BH_alpha,pa_Gilb)

#-------------------- summarize results: ---------------------------

tb <- cbind(fam_size,pi0,
            apply(pa_1,2,function(x) sum(x<=alpha)),
            apply(pa_2,2,function(x) sum(x<=alpha)),
            apply(pa_3,2,function(x) sum(x<=alpha)),
            apply(pa_4,2,function(x) sum(x<=alpha)))

return(tb)
}

```

```{r each_OC_separately_exe}
alpha <- 0.05
tb_each_oc_sep_0_05 <- NULL
for (i in 1:43)
  {
  OC_inds  <- 1:473 + 473*(i-1)
  tb <- main_proc(p = p[OC_inds],
                  alpha_star = alpha_star[OC_inds],
                  f_n = f_n[OC_inds],
                  kappa = kappa[OC_inds],
                  alpha = alpha,lambda = lambda)
  tb_each_oc_sep_0_05 <- rbind(tb_each_oc_sep_0_05,tb)
  }

tb_each_oc_sep_0_05_Total_of_BH_0.05 <- c(NA,NA,colSums(tb_each_oc_sep_0_05[2*(1:43)-1,3:6],na.rm = T))
tb_each_oc_sep_0_05_Total_of_Gilbert <- c(NA,NA,colSums(tb_each_oc_sep_0_05[2*(1:43)  ,3:6],na.rm = T))
tb_each_oc_sep_0_05_with_totals <- rbind(tb_each_oc_sep_0_05,
                                  tb_each_oc_sep_0_05_Total_of_BH_0.05,
                                  tb_each_oc_sep_0_05_Total_of_Gilbert)

alpha <- 0.04
tb_each_oc_sep_0_04 <- NULL
for (i in 1:43)
  {
  OC_inds  <- 1:473 + 473*(i-1)
  tb <- main_proc(p = p[OC_inds],
                  alpha_star = alpha_star[OC_inds],
                  f_n = f_n[OC_inds],
                  kappa = kappa[OC_inds],
                  alpha = alpha,lambda = lambda)
  tb_each_oc_sep_0_04 <- rbind(tb_each_oc_sep_0_04,tb)
  }

tb_each_oc_sep_0_04_Total_of_BH_0.04 <- c(NA,NA,colSums(tb_each_oc_sep_0_04[2*(1:43)-1,3:6],na.rm = T))
tb_each_oc_sep_0_04_Total_of_Gilbert <- c(NA,NA,colSums(tb_each_oc_sep_0_04[2*(1:43)  ,3:6],na.rm = T))
tb_each_oc_sep_0_04_with_totals <- rbind(tb_each_oc_sep_0_04,
                                  tb_each_oc_sep_0_04_Total_of_BH_0.04,
                                  tb_each_oc_sep_0_04_Total_of_Gilbert)

save(tb_each_oc_sep_0_05_with_totals,tb_each_oc_sep_0_04_with_totals,file="tables_each.RData")

```

```{r print_tables, include = T, eval = T, results='asis'}
rm(list = ls())
load("tables_all.RData")
load("tables_each.RData")
## 46 variables of interest:
XrayVariableList <- c("Number.Of.Thoracic.Vertebrae","Number.Of.Lumbar.Vertebrae","Number.Of.Pelvic.Vertebrae","Number.Of.Caudal.Vertebrae", "Transitional.Vertebrae" , "Shape.Of.Vertebrae","Fusion.Of.Vertebrae", "Processes.On.Vertebrae","Maxilla","Zygomatic.Bone","Number.Of.Cervical.Vertebrae","Skull.Shape","Number.Of.Ribs.Right","Number.Of.Ribs.Left","Shape.Of.Ribcage","Shape.Of.Ribs","Rib.Fusions","Clavicle","Scapula"  ,"Humerus","Radius","Ulna","Pelvis","Femur","Tibia","Fibula","Joints","Shape.Of.Spine","Teeth","Mandible","Number.Of.Digits","Digit.Integrity","Syndactylism","Polysyndactylism","Brachydactylism","Kyphosis","Lordosis","Scoliosis","Spinous.Processes","Transverse.Processes","Fusion.Processes","Caudal.Processes","Cervical.Processes","Lumbar.Processes","Sacral.Processes","Thoracic.Processes")    

## remove 3 variables with no values:
XrayVariableList_c <- XrayVariableList[!(XrayVariableList %in% c("Spinous.Processes","Transverse.Processes","Processes.On.Vertebrae"))]

#-------------  10 first 2x2 tables: -----------------
# pa_BH              <- p.adjust(p,"BH")
# ind <- which(pa_BH<=0.05)
# o <- order(pa_BH[ind])
# j <- 1
# for (i in ind[o][1:10])
#   {
#   print(kable(ptable(i %% 473,1+ (i %/% 473))))
#   }
# 
#-------------  Rejections in each procedure : -----------------

# table 1:
colnames(tb_all) <- c("size","pi_0","Original_pv",".","Mid_pv","..")
rownames(tb_all) <- c("BH","BH 0.05","Gilbert")

# table 2:
colnames(tb_rej_in_each_oc_0_05) <- c("Original_pv",".","Mid_pv","..")
rownames(tb_rej_in_each_oc_0_05) <- XrayVariableList_c

# table 3:
colnames(tb_rej_in_each_oc_Gilb) <- c("Original_pv",".","Mid_pv","..")
rownames(tb_rej_in_each_oc_Gilb) <- XrayVariableList_c

# table 4:
oc_names <- c(as.vector(rbind(XrayVariableList_c,NA)),"Total",NA)
colnames(tb_each_oc_sep_0_05_with_totals) <- c("size","pi_0","Original_pv",".","Mid_pv","..")
rownames(tb_each_oc_sep_0_05_with_totals) <- NULL 
tb_each_oc_sep_0_05_1 <- data.frame(oc_names,Family=rep(c("BH_0.05","Gilbert"),44),tb_each_oc_sep_0_05_with_totals)

# table 5:
colnames(tb_each_oc_sep_0_04_with_totals) <- c("size","pi_0","Original_pv",".","Mid_pv","..")
rownames(tb_each_oc_sep_0_04_with_totals) <- NULL 
tb_each_oc_sep_0_04_1 <- data.frame(oc_names,Family=rep(c("BH_0.05","Gilbert"),44),tb_each_oc_sep_0_04_with_totals)

kable(data.frame(tb_all),digits=4,caption="table 1:...",format="latex")
kable(data.frame(tb_rej_in_each_oc_0_05),caption="table 2:...",format="latex")
kable(data.frame(tb_rej_in_each_oc_Gilb),caption="table 3:...",format="latex")
kable(tb_each_oc_sep_0_05_1, digits=4,caption="table 4:...",format="latex")
kable(tb_each_oc_sep_0_04_1, digits=4,caption="table 5:...",format="latex")

```

